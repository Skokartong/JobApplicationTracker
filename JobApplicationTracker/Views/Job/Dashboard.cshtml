@model IEnumerable<JobApplicationTracker.Models.JobApplication>

@{
	var successMessage = TempData["SuccessMessage"] as string;
}

@if (!string.IsNullOrEmpty(successMessage))
{
	<div class="toast-container position-fixed top-0 end-0 p-3">
		<div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header">
				<strong class="me-auto">Success</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body">
				@successMessage
			</div>
		</div>
	</div>
}


@{
	ViewData["Title"] = "Job Applications";

	var statusCounts = new
	{
		Applied = Model.Count(j => j.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Applied),
		Interview = Model.Count(j => j.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Interview),
		Offer = Model.Count(j => j.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Offer),
		Rejected = Model.Count(j => j.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Rejected)
	};
}

<div class="container mt-5">

	<div class="mb-4">
		<h1>Hello @ViewBag.Name! 👋</h1>
		<p class="text-muted">
			@if (!Model.Any())
			{
				<text>Ready to start your job search? Add your first application!</text>
			}
			else
			{
				<text>You have @Model.Count() @(Model.Count() == 1 ? "application" : "applications") to track.</text>
			}
		</p>
	</div>

	<div class="row mb-4">
		<div class="col-md-3 mb-3">
			<div class="card text-white bg-primary h-100 shadow-sm clickable-card" data-status="Applied"
				style="cursor:pointer;">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>Applied</div>
					<i class="bi bi-briefcase-fill fs-3"></i>
				</div>
				<div class="card-footer text-center fs-3">@statusCounts.Applied</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card text-white bg-warning h-100 shadow-sm clickable-card" data-status="Interview"
				style="cursor:pointer;">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>Interview</div>
					<i class="bi bi-clock-fill fs-3"></i>
				</div>
				<div class="card-footer text-center fs-3">@statusCounts.Interview</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card text-white bg-success h-100 shadow-sm clickable-card" data-status="Offer"
				style="cursor:pointer;">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>Offer</div>
					<i class="bi bi-check-circle-fill fs-3"></i>
				</div>
				<div class="card-footer text-center fs-3">@statusCounts.Offer</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card text-white bg-danger h-100 shadow-sm clickable-card" data-status="Rejected"
				style="cursor:pointer;">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>Rejected</div>
					<i class="bi bi-x-circle-fill fs-3"></i>
				</div>
				<div class="card-footer text-center fs-3">@statusCounts.Rejected</div>
			</div>
		</div>
	</div>

	<div class="mb-4">
		<a class="btn btn-primary" asp-action="Add">+ Add New Application</a>
	</div>

	<div class="table-responsive">
		<table id="jobsTable" class="table table-bordered">
			<thead class="thead-custom">
				<tr>
					<th>Company</th>
					<th>Title</th>
					<th class="d-none d-md-table-cell">Category</th>
					<th>Status</th>
					<th class="d-none d-md-table-cell">Type</th>
					<th class="d-none d-md-table-cell">Level</th>
					<th class="d-none d-md-table-cell">Applied Date</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var application in Model)
				{
					<tr data-status="@application.Status">
						<td>@application.Company</td>
						<td>@application.Title</td>
						<td class="d-none d-md-table-cell">@application.JobCategory</td>
						<td
							class="@(application.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Applied ? "bg-primary text-white" :
											 	  application.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Interview ? "bg-warning text-white" :
										  	  application.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Offer ? "bg-success text-white" :
										  	  application.Status == JobApplicationTracker.Models.Enums.ApplicationStatus.Rejected ? "bg-danger text-white" : "")">
							@application.Status
						</td>
						<td class="d-none d-md-table-cell">@application.Type</td>
						<td class="d-none d-md-table-cell">@application.Level</td>
						<td class="d-none d-md-table-cell">@application.AppliedDate.ToShortDateString()</td>
						<td>
							<a asp-action="Update" asp-route-id="@application.Id"
								class="btn btn-warning btn-sm rounded-pill">Edit</a>
							<form asp-action="Delete" method="post" class="d-inline"
								onsubmit="return confirm('Are you sure you want to delete this job application?');">
								<input type="hidden" name="Id" value="@application.Id" />
								<button type="submit" class="btn btn-danger btn-sm rounded-pill">Delete</button>
							</form>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
</div>

@section Scripts {
	<script>
		document.querySelectorAll('.clickable-card').forEach(card => {
			card.addEventListener('click', function () {
				const status = this.dataset.status;
				const tableBody = document.querySelector('#jobsTable tbody');
				const rows = Array.from(tableBody.querySelectorAll('tr'));
				rows.sort((a, b) => {
					const aStatus = a.dataset.status;
					const bStatus = b.dataset.status;
					if (aStatus === status && bStatus !== status) return -1;
					if (aStatus !== status && bStatus === status) return 1;
					return 0;
				});
				rows.forEach(r => tableBody.appendChild(r));
			});
		});

		$(document).ready(function () {
			setTimeout(function () {
				$('.toast').toast('hide');
			}, 3000);
		});
	</script>
	}
}